{% extends "dashboard/base.html" %} {% block dashboard_content %}
<div class="welcome-section">
  <div class="section-header">
    <div>
      <h1>All Expenses</h1>
      <p>View and manage your expense history</p>
    </div>
    <div class="header-actions">
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
      <button class="btn btn-info" onclick="exportCSV()">
        <i class="fas fa-file-csv"></i> Export CSV
      </button>
      <button class="btn btn-warning" onclick="exportPDF()">
        <i class="fas fa-file-pdf"></i> Export PDF
      </button>
    </div>
  </div>
</div>

<!-- Enhanced Filters Section -->
<div class="filters-section">
  <div class="filters-card">
    <h3><i class="fas fa-filter"></i> Filter Expenses</h3>

    <div class="form-row">
      <div class="form-group">
        <label for="categoryFilter">Category</label>
        <select class="form-control" id="categoryFilter">
          <option value="">All Categories</option>
          <option value="Food">üçï Food & Dining</option>
          <option value="Transport">üöó Transport</option>
          <option value="Shopping">üõçÔ∏è Shopping</option>
          <option value="Bills">üìÑ Bills & Utilities</option>
          <option value="Entertainment">üé¨ Entertainment</option>
          <option value="Healthcare">üè• Healthcare</option>
          <option value="Education">üìö Education</option>
          <option value="Travel">‚úàÔ∏è Travel</option>
          <option value="Other">üì¶ Other</option>
        </select>
      </div>

      <div class="form-group">
        <label for="dateFrom">From Date</label>
        <input type="date" class="form-control" id="dateFrom" />
      </div>

      <div class="form-group">
        <label for="dateTo">To Date</label>
        <input type="date" class="form-control" id="dateTo" />
      </div>

      <div class="form-group">
        <label for="amountMin">Min Amount (‚Çπ)</label>
        <input
          type="number"
          class="form-control"
          id="amountMin"
          step="0.01"
          min="0"
        />
      </div>

      <div class="form-group">
        <label for="amountMax">Max Amount (‚Çπ)</label>
        <input
          type="number"
          class="form-control"
          id="amountMax"
          step="0.01"
          min="0"
        />
      </div>
    </div>

    <div class="filter-actions">
      <button type="button" class="btn btn-primary" onclick="applyFilters()">
        <i class="fas fa-filter"></i> Apply Filters
      </button>
      <button type="button" class="btn btn-secondary" onclick="clearFilters()">
        <i class="fas fa-times"></i> Clear Filters
      </button>
      <button type="button" class="btn btn-info" onclick="saveFilterPreset()">
        <i class="fas fa-save"></i> Save Preset
      </button>
    </div>

    <!-- Saved Presets -->
    <div
      id="filterPresets"
      class="filter-presets"
      style="margin-top: 15px; display: none"
    >
      <label>Saved Presets:</label>
      <div id="presetsList" class="presets-list"></div>
    </div>
  </div>
</div>

<!-- Expenses List -->
<div class="expenses-list">
  <div class="list-header">
    <h2>Expense History</h2>
    <div class="list-stats">
      <div id="totalDisplay" class="total-amount">Total: ‚Çπ0.00</div>
      <div id="countDisplay" class="count-display">
        <span id="expenseCount">0</span> expenses
      </div>
    </div>
  </div>

  <div id="expensesList">
    <!-- Expenses will be loaded here -->
  </div>

  <div id="loadingMessage" class="loading-state">
    <i class="fas fa-spinner fa-spin fa-2x"></i>
    <p>Loading expenses...</p>
  </div>

  <div id="noExpensesMessage" class="empty-state" style="display: none">
    <i class="fas fa-receipt fa-3x"></i>
    <h3>No expenses found</h3>
    <p>Start by adding your first expense from the dashboard.</p>
    <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
      <i class="fas fa-plus"></i> Add Expense
    </a>
  </div>

  <!-- Pagination -->
  <div id="pagination" class="pagination" style="display: none">
    <button id="prevPage" class="btn btn-secondary" onclick="changePage(-1)">
      <i class="fas fa-chevron-left"></i> Previous
    </button>
    <span id="pageInfo" class="page-info">Page 1 of 1</span>
    <button id="nextPage" class="btn btn-secondary" onclick="changePage(1)">
      Next <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</div>

<style>
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
  }

  .header-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .filters-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
  }

  .filter-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .filter-presets {
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
  }

  .presets-list {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
  }

  .preset-tag {
    background: #e9ecef;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .preset-tag:hover {
    background: #dee2e6;
  }

  .preset-tag .remove {
    color: #6c757d;
    cursor: pointer;
  }

  .preset-tag .remove:hover {
    color: #dc3545;
  }

  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
  }

  .list-stats {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .total-amount {
    font-size: 1.3rem;
    font-weight: bold;
    color: #4361ee;
  }

  .count-display {
    color: #6c757d;
    font-size: 0.9rem;
  }

  .expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: white;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
  }

  .expense-item:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }

  .expense-item.editing {
    background: #f8f9fa;
    border-left: 4px solid #4361ee;
  }

  .expense-info {
    flex: 1;
    min-width: 0;
  }

  .expense-main {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 8px;
  }

  .expense-amount {
    font-size: 1.3rem;
    font-weight: bold;
    color: #f72585;
    min-width: 100px;
  }

  .expense-category {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .expense-description {
    margin: 5px 0;
    color: #495057;
    word-break: break-word;
  }

  .expense-date {
    color: #6c757d;
    font-size: 0.9rem;
  }

  .expense-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .edit-btn,
  .save-btn,
  .cancel-btn,
  .delete-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s ease;
  }

  .edit-btn {
    background: #4cc9f0;
    color: white;
  }

  .edit-btn:hover {
    background: #3ab8dd;
  }

  .save-btn {
    background: #43aa8b;
    color: white;
  }

  .save-btn:hover {
    background: #389174;
  }

  .cancel-btn {
    background: #6c757d;
    color: white;
  }

  .cancel-btn:hover {
    background: #5a6268;
  }

  .delete-btn {
    background: #f72585;
    color: white;
  }

  .delete-btn:hover {
    background: #d1144a;
  }

  .edit-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 0.9rem;
  }

  .edit-select {
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    font-size: 0.9rem;
    background: white;
  }

  .loading-state,
  .empty-state {
    text-align: center;
    padding: 40px;
    color: #6c757d;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 30px;
    padding: 20px;
  }

  .page-info {
    color: #6c757d;
    font-weight: 600;
  }

  /* Category colors */
  .expense-food {
    background: #ffe5ec;
    color: #c9184a;
  }
  .expense-transport {
    background: #e2eafc;
    color: #1d4ed8;
  }
  .expense-shopping {
    background: #fff0f3;
    color: #e63946;
  }
  .expense-bills {
    background: #f8f9fa;
    color: #6c757d;
  }
  .expense-entertainment {
    background: #fff3cd;
    color: #856404;
  }
  .expense-healthcare {
    background: #d1ecf1;
    color: #0c5460;
  }
  .expense-education {
    background: #d4edda;
    color: #155724;
  }
  .expense-travel {
    background: #e2e3e5;
    color: #383d41;
  }
  .expense-other {
    background: #f8d7da;
    color: #721c24;
  }

  @media (max-width: 768px) {
    .section-header {
      flex-direction: column;
      gap: 15px;
    }

    .header-actions {
      width: 100%;
      justify-content: flex-start;
    }

    .expense-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }

    .expense-actions {
      width: 100%;
      justify-content: flex-end;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  let allExpenses = [];
  let currentPage = 1;
  const itemsPerPage = 10;
  let currentFilters = {};

  document.addEventListener("DOMContentLoaded", function () {
    loadAllExpenses();
    loadFilterPresets();
  });

  async function loadAllExpenses() {
    try {
      showLoading(true);
      const response = await fetch("/get-expenses");
      allExpenses = await response.json();
      displayExpenses(allExpenses);
      updatePagination();
    } catch (error) {
      console.error("Error loading expenses:", error);
      showError("Error loading expenses: " + error.message);
    } finally {
      showLoading(false);
    }
  }

  function displayExpenses(expenses) {
    const container = document.getElementById("expensesList");
    const noExpensesMessage = document.getElementById("noExpensesMessage");
    const pagination = document.getElementById("pagination");

    if (expenses.length === 0) {
      container.innerHTML = "";
      noExpensesMessage.style.display = "block";
      pagination.style.display = "none";
      updateTotalDisplay(0, 0);
      return;
    }

    noExpensesMessage.style.display = "none";
    pagination.style.display = "flex";

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageExpenses = expenses.slice(startIndex, endIndex);

    let total = 0;
    let html = "";

    pageExpenses.forEach((expense) => {
      total += parseFloat(expense.amount);

      html += `
        <div class="expense-item" id="expense-${expense.id}">
          <div class="expense-info">
            <div class="expense-main">
              <div class="expense-amount" id="amount-${expense.id}">
                ‚Çπ${parseFloat(expense.amount).toFixed(2)}
              </div>
              <span class="expense-category expense-${expense.category.toLowerCase()}" id="category-${
        expense.id
      }">
                ${expense.category}
              </span>
            </div>
            <div class="expense-description" id="description-${expense.id}">
              ${expense.description || "No description provided"}
            </div>
            <div class="expense-date" id="date-${expense.id}">
              ${expense.date} ‚Ä¢ Added on ${expense.created_at}
            </div>
          </div>
          <div class="expense-actions">
            <button class="edit-btn" onclick="enableEdit('${expense.id}')">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="delete-btn" onclick="deleteExpense('${expense.id}')">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
    updateTotalDisplay(total, expenses.length);
  }

  function enableEdit(expenseId) {
    const expenseItem = document.getElementById(`expense-${expenseId}`);
    const amount = document
      .getElementById(`amount-${expenseId}`)
      .textContent.replace("‚Çπ", "");
    const category = document.getElementById(
      `category-${expenseId}`
    ).textContent;
    const description = document.getElementById(
      `description-${expenseId}`
    ).textContent;
    const date = document
      .getElementById(`date-${expenseId}`)
      .textContent.split(" ‚Ä¢ ")[0];

    expenseItem.classList.add("editing");

    expenseItem.innerHTML = `
      <div class="expense-info">
        <div class="expense-main">
          <input type="number" class="edit-input" id="edit-amount-${expenseId}" 
                 value="${amount}" step="0.01" min="0" style="width: 120px;">
          <select class="edit-select" id="edit-category-${expenseId}">
            <option value="Food" ${
              category === "Food" ? "selected" : ""
            }>Food</option>
            <option value="Transport" ${
              category === "Transport" ? "selected" : ""
            }>Transport</option>
            <option value="Shopping" ${
              category === "Shopping" ? "selected" : ""
            }>Shopping</option>
            <option value="Bills" ${
              category === "Bills" ? "selected" : ""
            }>Bills</option>
            <option value="Entertainment" ${
              category === "Entertainment" ? "selected" : ""
            }>Entertainment</option>
            <option value="Healthcare" ${
              category === "Healthcare" ? "selected" : ""
            }>Healthcare</option>
            <option value="Education" ${
              category === "Education" ? "selected" : ""
            }>Education</option>
            <option value="Travel" ${
              category === "Travel" ? "selected" : ""
            }>Travel</option>
            <option value="Other" ${
              category === "Other" ? "selected" : ""
            }>Other</option>
          </select>
        </div>
        <textarea class="edit-input" id="edit-description-${expenseId}" 
                  rows="2" placeholder="Description">${
                    description === "No description provided" ? "" : description
                  }</textarea>
        <input type="date" class="edit-input" id="edit-date-${expenseId}" value="${date}" style="width: 150px;">
      </div>
      <div class="expense-actions">
        <button class="save-btn" onclick="saveEdit('${expenseId}')">
          <i class="fas fa-save"></i> Save
        </button>
        <button class="cancel-btn" onclick="cancelEdit('${expenseId}')">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    `;
  }

  async function saveEdit(expenseId) {
    try {
      const amount = document.getElementById(`edit-amount-${expenseId}`).value;
      const category = document.getElementById(
        `edit-category-${expenseId}`
      ).value;
      const description = document.getElementById(
        `edit-description-${expenseId}`
      ).value;
      const date = document.getElementById(`edit-date-${expenseId}`).value;

      const response = await fetch(`/api/expenses/${expenseId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          amount: parseFloat(amount),
          category: category,
          description: description,
          date: date,
        }),
      });

      if (response.ok) {
        showNotification("Expense updated successfully!", "success");
        loadAllExpenses(); // Reload to reflect changes
      } else {
        throw new Error("Failed to update expense");
      }
    } catch (error) {
      showNotification("Error updating expense: " + error.message, "error");
    }
  }

  function cancelEdit(expenseId) {
    loadAllExpenses(); // Reload to revert changes
  }

  function applyFilters() {
    const categoryFilter = document.getElementById("categoryFilter").value;
    const dateFrom = document.getElementById("dateFrom").value;
    const dateTo = document.getElementById("dateTo").value;
    const amountMin = document.getElementById("amountMin").value;
    const amountMax = document.getElementById("amountMax").value;

    currentFilters = {
      category: categoryFilter,
      dateFrom: dateFrom,
      dateTo: dateTo,
      amountMin: amountMin,
      amountMax: amountMax,
    };

    let filteredExpenses = allExpenses;

    if (categoryFilter) {
      filteredExpenses = filteredExpenses.filter(
        (expense) => expense.category === categoryFilter
      );
    }

    if (dateFrom) {
      filteredExpenses = filteredExpenses.filter(
        (expense) => expense.date >= dateFrom
      );
    }

    if (dateTo) {
      filteredExpenses = filteredExpenses.filter(
        (expense) => expense.date <= dateTo
      );
    }

    if (amountMin) {
      filteredExpenses = filteredExpenses.filter(
        (expense) => parseFloat(expense.amount) >= parseFloat(amountMin)
      );
    }

    if (amountMax) {
      filteredExpenses = filteredExpenses.filter(
        (expense) => parseFloat(expense.amount) <= parseFloat(amountMax)
      );
    }

    currentPage = 1;
    displayExpenses(filteredExpenses);
    updatePagination(filteredExpenses.length);
  }

  function clearFilters() {
    document.getElementById("categoryFilter").value = "";
    document.getElementById("dateFrom").value = "";
    document.getElementById("dateTo").value = "";
    document.getElementById("amountMin").value = "";
    document.getElementById("amountMax").value = "";

    currentFilters = {};
    currentPage = 1;
    displayExpenses(allExpenses);
    updatePagination();
  }

  function saveFilterPreset() {
    const presets = JSON.parse(
      localStorage.getItem("expenseFilterPresets") || "[]"
    );
    const presetName = prompt("Enter a name for this filter preset:");

    if (presetName) {
      presets.push({
        name: presetName,
        filters: currentFilters,
        timestamp: new Date().toISOString(),
      });

      localStorage.setItem("expenseFilterPresets", JSON.stringify(presets));
      loadFilterPresets();
      showNotification("Filter preset saved!", "success");
    }
  }

  function loadFilterPresets() {
    const presets = JSON.parse(
      localStorage.getItem("expenseFilterPresets") || "[]"
    );
    const container = document.getElementById("filterPresets");
    const list = document.getElementById("presetsList");

    if (presets.length === 0) {
      container.style.display = "none";
      return;
    }

    container.style.display = "block";
    list.innerHTML = "";

    presets.forEach((preset, index) => {
      const tag = document.createElement("div");
      tag.className = "preset-tag";
      tag.innerHTML = `
        <span onclick="loadFilterPreset(${index})">${preset.name}</span>
        <span class="remove" onclick="removeFilterPreset(${index})">&times;</span>
      `;
      list.appendChild(tag);
    });
  }

  function loadFilterPreset(index) {
    const presets = JSON.parse(
      localStorage.getItem("expenseFilterPresets") || "[]"
    );
    const preset = presets[index];

    if (preset) {
      document.getElementById("categoryFilter").value =
        preset.filters.category || "";
      document.getElementById("dateFrom").value = preset.filters.dateFrom || "";
      document.getElementById("dateTo").value = preset.filters.dateTo || "";
      document.getElementById("amountMin").value =
        preset.filters.amountMin || "";
      document.getElementById("amountMax").value =
        preset.filters.amountMax || "";

      currentFilters = preset.filters;
      applyFilters();
      showNotification(`Loaded preset: ${preset.name}`, "info");
    }
  }

  function removeFilterPreset(index) {
    const presets = JSON.parse(
      localStorage.getItem("expenseFilterPresets") || "[]"
    );
    presets.splice(index, 1);
    localStorage.setItem("expenseFilterPresets", JSON.stringify(presets));
    loadFilterPresets();
    showNotification("Filter preset removed!", "info");
  }

  function changePage(direction) {
    const filteredExpenses = getFilteredExpenses();
    const totalPages = Math.ceil(filteredExpenses.length / itemsPerPage);

    currentPage += direction;
    if (currentPage < 1) currentPage = 1;
    if (currentPage > totalPages) currentPage = totalPages;

    displayExpenses(filteredExpenses);
    updatePagination(filteredExpenses.length);
  }

  function updatePagination(totalItems = allExpenses.length) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const pageInfo = document.getElementById("pageInfo");
    const prevBtn = document.getElementById("prevPage");
    const nextBtn = document.getElementById("nextPage");

    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages || totalPages === 0;
  }

  function updateTotalDisplay(total, count) {
    document.getElementById(
      "totalDisplay"
    ).textContent = `Total: ‚Çπ${total.toFixed(2)}`;
    document.getElementById("expenseCount").textContent = count;
  }

  function getFilteredExpenses() {
    // This would return the currently filtered expenses
    // For now, return all expenses (you can implement proper filtering logic)
    return allExpenses;
  }

  function showLoading(show) {
    document.getElementById("loadingMessage").style.display = show
      ? "block"
      : "none";
  }

  function showError(message) {
    const container = document.getElementById("expensesList");
    container.innerHTML = `<div class="alert alert-error">${message}</div>`;
  }

  // Export functions (same as in index.html)
  async function exportCSV() {
    try {
      const response = await fetch("/api/export/csv");
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `expenses-${new Date().toISOString().split("T")[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      showNotification("CSV export started!", "success");
    } catch (error) {
      showNotification("Error exporting CSV: " + error.message, "error");
    }
  }

  async function exportPDF() {
    try {
      const response = await fetch("/api/export/pdf");
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `expenses-report-${
        new Date().toISOString().split("T")[0]
      }.pdf`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      showNotification("PDF export started!", "success");
    } catch (error) {
      showNotification("Error exporting PDF: " + error.message, "error");
    }
  }

  function showNotification(message, type = "info") {
    // Same implementation as in index.html
    const notification = document.createElement("div");
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      border-left: 4px solid #4361ee;
      animation: slideInRight 0.3s ease;
    `;

    if (type === "success") notification.style.borderLeftColor = "#4cc9f0";
    if (type === "error") notification.style.borderLeftColor = "#f72585";

    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 5000);
  }
</script>
{% endblock %}
