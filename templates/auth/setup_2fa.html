{% extends "layout.html" %} {% block content %}
<div class="auth-container">
  <div class="auth-layout">
    <!-- Left Side - Image Section -->
    <div class="auth-left">
      <div class="auth-image">
        <img
          src="https://images.unsplash.com/photo-1614064641938-3bbee52942c7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1000&q=80"
          alt="Two-Factor Authentication"
        />
        <link
          rel="stylesheet"
          href="{{ url_for('static', filename='css/auth.css') }}"
        />
        <div class="image-overlay">
          <div class="overlay-content">
            <h2>Enhanced Security</h2>
            <p>Protect your account with an extra layer of security</p>
            <div class="features-list">
              <div class="feature-item">
                <i class="fas fa-mobile-alt"></i>
                <span>Mobile Authenticator</span>
              </div>
              <div class="feature-item">
                <i class="fas fa-qrcode"></i>
                <span>Quick QR Setup</span>
              </div>
              <div class="feature-item">
                <i class="fas fa-backup"></i>
                <span>Backup Codes</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Side - Form Section -->
    <div class="auth-right">
      <div class="auth-card">
        <div class="auth-header">
          <h1>Pynex</h1>
          <p>Setup Two-Factor Authentication</p>
          <p class="text-muted">
            Secure your account with two-factor authentication
          </p>
        </div>

        <div class="setup-steps">
          <div class="step active" id="step1">
            <h3>Step 1: Scan QR Code</h3>
            <div class="qr-container">
              <img
                src="{{ qr_code }}"
                alt="QR Code for 2FA Setup"
                id="qrCode"
              />
            </div>
            <div class="manual-setup">
              <p class="text-muted">
                Can't scan the QR code? Enter this code manually:
              </p>
              <div class="secret-code">
                <code id="secretCode">{{ secret }}</code>
                <button type="button" id="copySecret" class="btn-copy">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="step-actions">
              <button type="button" class="btn btn-primary" id="nextStep">
                Next: Verify Code
              </button>
            </div>
          </div>

          <div class="step" id="step2">
            <h3>Step 2: Verify Setup</h3>
            <p class="text-muted">
              Enter the 6-digit code from your authenticator app to verify the
              setup
            </p>
            <form id="verify2faForm">
              <div class="form-group">
                <label for="otp">6-digit Verification Code</label>
                <input
                  type="text"
                  class="form-control"
                  id="otp"
                  name="otp"
                  maxlength="6"
                  pattern="[0-9]{6}"
                  placeholder="000000"
                  required
                />
                <small class="form-text text-muted">
                  Open your authenticator app and enter the code shown
                </small>
              </div>

              <div class="form-group">
                <div class="form-check">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="backupCodesDownloaded"
                  />
                  <label class="form-check-label" for="backupCodesDownloaded">
                    I have saved my backup codes
                  </label>
                </div>
              </div>

              <div class="step-actions">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="prevStep"
                >
                  Back
                </button>
                <button type="submit" class="btn btn-primary">
                  Complete Setup
                </button>
              </div>
            </form>
          </div>

          <div class="step" id="step3">
            <h3>Step 3: Backup Codes</h3>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <strong>Important:</strong> Save these backup codes in a secure
              location. You can use them to access your account if you lose your
              authenticator app.
            </div>

            <div class="backup-codes-container">
              <div class="backup-codes">
                {% for code in backup_codes %}
                <div class="backup-code">{{ code }}</div>
                {% endfor %}
              </div>
            </div>

            <div class="backup-actions">
              <button
                type="button"
                class="btn btn-outline-primary"
                id="printCodes"
              >
                <i class="fas fa-print"></i> Print Codes
              </button>
              <button
                type="button"
                class="btn btn-outline-primary"
                id="downloadCodes"
              >
                <i class="fas fa-download"></i> Download as Text
              </button>
            </div>

            <div class="step-actions">
              <button type="button" class="btn btn-primary" id="finishSetup">
                Finish Setup
              </button>
            </div>
          </div>
        </div>

        <div class="auth-links">
          <a href="{{ url_for('dashboard') }}">Skip for now</a>
          <span> | </span>
          <a href="#" id="helpLink">Need help?</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let currentStep = 1;
    const totalSteps = 3;

    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");
    const nextBtn = document.getElementById("nextStep");
    const prevBtn = document.getElementById("prevStep");
    const finishBtn = document.getElementById("finishSetup");
    const verifyForm = document.getElementById("verify2faForm");
    const copyBtn = document.getElementById("copySecret");
    const printBtn = document.getElementById("printCodes");
    const downloadBtn = document.getElementById("downloadCodes");
    const helpLink = document.getElementById("helpLink");

    // Step navigation
    nextBtn.addEventListener("click", function () {
      if (currentStep < totalSteps) {
        showStep(currentStep + 1);
      }
    });

    prevBtn.addEventListener("click", function () {
      if (currentStep > 1) {
        showStep(currentStep - 1);
      }
    });

    finishBtn.addEventListener("click", function () {
      window.location.href = "{{ url_for('dashboard') }}";
    });

    // Copy secret to clipboard
    copyBtn.addEventListener("click", function () {
      const secretCode = document.getElementById("secretCode").textContent;
      navigator.clipboard
        .writeText(secretCode)
        .then(function () {
          showAlert("Secret code copied to clipboard", "success");
        })
        .catch(function () {
          showAlert("Failed to copy secret code", "error");
        });
    });

    // Print backup codes
    printBtn.addEventListener("click", function () {
      const backupCodes = document.querySelector(".backup-codes").innerHTML;
      const printWindow = window.open("", "_blank");
      printWindow.document.write(`
        <html>
          <head>
            <title>Pynex - 2FA Backup Codes</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; }
              h1 { color: #333; }
              .backup-codes { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
              .backup-code { border: 1px solid #333; padding: 10px; text-align: center; font-family: monospace; }
              .warning { color: #856404; background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin: 20px 0; }
            </style>
          </head>
          <body>
            <h1>Pynex - Two-Factor Authentication Backup Codes</h1>
            <div class="warning">
              <strong>Important:</strong> Keep these codes in a safe place. Each code can be used only once.
            </div>
            <div class="backup-codes">
              ${backupCodes}
            </div>
            <p><small>Generated on: ${new Date().toLocaleDateString()}</small></p>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    });

    // Download backup codes as text
    downloadBtn.addEventListener("click", function () {
      const codes = Array.from(document.querySelectorAll(".backup-code"))
        .map((code) => code.textContent)
        .join("\n");

      const blob = new Blob(
        [
          `Pynex 2FA Backup Codes\n\n${codes}\n\nGenerated on: ${new Date().toLocaleDateString()}\n\nImportant: Each code can be used only once.`,
        ],
        { type: "text/plain" }
      );
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "pynex-2fa-backup-codes.txt";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Verify 2FA setup
    verifyForm.addEventListener("submit", function (e) {
      e.preventDefault();

      const otp = document.getElementById("otp").value.trim();
      const backupCodesChecked = document.getElementById(
        "backupCodesDownloaded"
      ).checked;

      if (otp.length !== 6 || !/^\d+$/.test(otp)) {
        showAlert("Please enter a valid 6-digit code", "error");
        return;
      }

      if (!backupCodesChecked) {
        showAlert("Please confirm you have saved your backup codes", "error");
        return;
      }

      const submitBtn = verifyForm.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;

      submitBtn.disabled = true;
      submitBtn.textContent = "Verifying...";

      fetch("/auth/setup-2fa", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          otp: otp,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert(data.message, "success");
            showStep(3); // Show backup codes step
          } else {
            showAlert(data.error, "error");
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        })
        .catch((error) => {
          showAlert("An error occurred during verification", "error");
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        });
    });

    // Help link
    helpLink.addEventListener("click", function (e) {
      e.preventDefault();

      let helpContent = document.getElementById("helpContent");
      if (!helpContent) {
        helpContent = document.createElement("div");
        helpContent.id = "helpContent";
        helpContent.className = "help-content";
        helpContent.innerHTML = `
          <h4>Setting Up Two-Factor Authentication</h4>
          <p>Follow these steps to set up 2FA:</p>
          <ul>
            <li><strong>Step 1:</strong> Install an authenticator app like Google Authenticator, Authy, or Microsoft Authenticator on your phone</li>
            <li><strong>Step 2:</strong> Scan the QR code with your app or manually enter the secret code</li>
            <li><strong>Step 3:</strong> Enter the 6-digit code generated by your app to verify the setup</li>
            <li><strong>Step 4:</strong> Save your backup codes in a secure location</li>
          </ul>
          <p><strong>Note:</strong> You'll need to enter a code from your authenticator app every time you log in.</p>
        `;
        helpLink.parentNode.insertBefore(helpContent, helpLink.nextSibling);
      }

      helpContent.style.display =
        helpContent.style.display === "none" ? "block" : "none";
    });

    function showStep(stepNumber) {
      // Hide all steps
      step1.classList.remove("active");
      step2.classList.remove("active");
      step3.classList.remove("active");

      // Show current step
      document.getElementById(`step${stepNumber}`).classList.add("active");
      currentStep = stepNumber;
    }

    function showAlert(message, type) {
      // Remove existing alerts
      const existingAlert = document.querySelector(".alert");
      if (existingAlert) {
        existingAlert.remove();
      }

      const alertDiv = document.createElement("div");
      alertDiv.className = `alert alert-${type === "error" ? "danger" : type}`;
      alertDiv.innerHTML = `
        <i class="fas fa-${
          type === "error" ? "exclamation-triangle" : "check-circle"
        }"></i>
        ${message}
      `;

      const currentStep = document.getElementById(`step${currentStep}`);
      currentStep.insertBefore(alertDiv, currentStep.firstChild);

      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }
  });
</script>
{% endblock %}
